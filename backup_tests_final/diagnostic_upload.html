<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagnostic Upload Photo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { border: 1px solid #ddd; margin: 20px 0; padding: 20px; border-radius: 8px; background: #f9f9f9; }
        .test-item { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.error { background: #dc3545; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        input[type="file"] { margin: 10px 0; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; margin: 10px 0; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Upload Photo - Analyse Compl√®te</h1>
        
        <div class="section">
            <h2>1. V√©rification de l'Environnement</h2>
            <div class="test-item">
                <button onclick="checkEnvironment()">V√©rifier l'environnement</button>
                <div id="envResult"></div>
            </div>
        </div>

        <div class="section">
            <h2>2. Test de Connexion</h2>
            <div class="test-item">
                <button onclick="testLogin()">Se connecter en tant qu'Admin</button>
                <div id="loginResult"></div>
            </div>
        </div>

        <div class="section">
            <h2>3. V√©rification Token</h2>
            <div class="test-item">
                <button onclick="checkToken()">Analyser le token stock√©</button>
                <div id="tokenResult"></div>
            </div>
        </div>

        <div class="section">
            <h2>4. Test Endpoints</h2>
            <div class="test-item">
                <button onclick="testEndpoints()">Tester les endpoints</button>
                <div id="endpointsResult"></div>
            </div>
        </div>

        <div class="section">
            <h2>5. Test Upload Photo</h2>
            <div class="test-item">
                <label>S√©lectionner une image:</label>
                <input type="file" id="testImage" accept="image/*">
                <br>
                <label>ID Enseignant:</label>
                <input type="number" id="enseignantId" value="14" style="width: 100px; padding: 5px;">
                <br>
                <button onclick="testUpload()">Tester Upload</button>
                <div id="uploadResult"></div>
            </div>
        </div>

        <div class="section">
            <h2>üìã Log D√©taill√©</h2>
            <button onclick="clearLog()">Effacer Log</button>
            <div id="detailedLog" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let authToken = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('detailedLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('detailedLog').innerHTML = '';
        }

        function updateResult(elementId, content, className = '') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            if (className) element.className = `result ${className}`;
        }

        async function checkEnvironment() {
            log('üîç V√©rification de l\'environnement...', 'info');
            
            try {
                // V√©rifier localStorage
                const hasLocalStorage = typeof(Storage) !== "undefined";
                log(`‚úÖ LocalStorage: ${hasLocalStorage ? 'Disponible' : 'Non disponible'}`, hasLocalStorage ? 'success' : 'error');
                
                // V√©rifier le token existant
                const existingToken = localStorage.getItem('access_token');
                log(`üîë Token existant: ${existingToken ? `${existingToken.substring(0, 30)}...` : 'Aucun'}`, existingToken ? 'success' : 'warning');
                
                // V√©rifier la connectivit√© au backend
                const healthResponse = await fetch(`${API_BASE}/health`);
                const healthData = await healthResponse.json();
                log(`üè• Backend health: ${healthData.status}`, 'success');
                
                updateResult('envResult', `
                    <div class="success">‚úÖ Environnement OK</div>
                    <ul>
                        <li>LocalStorage: ${hasLocalStorage ? 'OK' : 'NOK'}</li>
                        <li>Token: ${existingToken ? 'Pr√©sent' : 'Absent'}</li>
                        <li>Backend: ${healthData.status}</li>
                    </ul>
                `, 'success');
                
            } catch (error) {
                log(`‚ùå Erreur environnement: ${error.message}`, 'error');
                updateResult('envResult', `<div class="error">‚ùå Erreur: ${error.message}</div>`, 'error');
            }
        }

        async function testLogin() {
            log('üîê Test de connexion admin...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        username: 'admin@univ.ma',
                        password: 'admin123'
                    })
                });

                log(`üì° Statut login: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    localStorage.setItem('access_token', authToken);
                    
                    log(`‚úÖ Connexion r√©ussie. Token: ${authToken.substring(0, 50)}...`, 'success');
                    log(`üíæ Token sauvegard√© dans localStorage`, 'success');
                    
                    updateResult('loginResult', `
                        <div class="success">‚úÖ Connexion r√©ussie</div>
                        <p>Token: ${authToken.substring(0, 50)}...</p>
                        <p>Type: ${data.token_type}</p>
                    `, 'success');
                } else {
                    const errorData = await response.json();
                    log(`‚ùå √âchec login: ${errorData.detail}`, 'error');
                    updateResult('loginResult', `<div class="error">‚ùå √âchec: ${errorData.detail}</div>`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur connexion: ${error.message}`, 'error');
                updateResult('loginResult', `<div class="error">‚ùå Erreur: ${error.message}</div>`, 'error');
            }
        }

        async function checkToken() {
            log('üîç Analyse du token...', 'info');
            
            const token = localStorage.getItem('access_token') || authToken;
            
            if (!token) {
                log('‚ùå Aucun token trouv√©', 'error');
                updateResult('tokenResult', '<div class="error">‚ùå Aucun token trouv√©</div>', 'error');
                return;
            }

            log(`üîë Token trouv√©: ${token.substring(0, 50)}...`, 'success');
            log(`üìè Longueur: ${token.length} caract√®res`, 'info');
            
            // Analyser la structure du token
            if (token.startsWith('test_token_')) {
                const parts = token.split('_');
                log(`üîß Token de test avec ${parts.length} parties: ${parts.join(' | ')}`, 'info');
                
                if (parts.includes('admin')) {
                    log('‚úÖ Token contient "admin"', 'success');
                } else {
                    log('‚ö†Ô∏è Token ne contient pas "admin"', 'warning');
                }
            } else {
                log('üîß Token JWT ou autre format', 'info');
            }

            updateResult('tokenResult', `
                <div class="success">‚úÖ Token analys√©</div>
                <p>Token: ${token.substring(0, 50)}...</p>
                <p>Longueur: ${token.length}</p>
                <p>Type: ${token.startsWith('test_token_') ? 'Test Token' : 'JWT ou autre'}</p>
            `, 'success');
        }

        async function testEndpoints() {
            log('üß™ Test des endpoints...', 'info');
            
            const token = localStorage.getItem('access_token') || authToken;
            if (!token) {
                log('‚ùå Pas de token pour tester les endpoints', 'error');
                updateResult('endpointsResult', '<div class="error">‚ùå Token requis</div>', 'error');
                return;
            }

            const endpoints = [
                { name: 'Health', url: '/health', method: 'GET', needAuth: false },
                { name: 'Auth Me', url: '/auth/me', method: 'GET', needAuth: true },
                { name: 'Enseignants', url: '/users/enseignants', method: 'GET', needAuth: true },
            ];

            let results = '';
            
            for (const endpoint of endpoints) {
                try {
                    log(`üì° Test ${endpoint.name}...`, 'info');
                    
                    const headers = { 'Content-Type': 'application/json' };
                    if (endpoint.needAuth) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    const response = await fetch(`${API_BASE}${endpoint.url}`, {
                        method: endpoint.method,
                        headers
                    });

                    const status = response.status;
                    const statusClass = response.ok ? 'success' : 'error';
                    
                    log(`${response.ok ? '‚úÖ' : '‚ùå'} ${endpoint.name}: ${status}`, statusClass);
                    results += `<p>${response.ok ? '‚úÖ' : '‚ùå'} ${endpoint.name}: ${status}</p>`;
                    
                } catch (error) {
                    log(`‚ùå ${endpoint.name}: ${error.message}`, 'error');
                    results += `<p>‚ùå ${endpoint.name}: ${error.message}</p>`;
                }
            }

            updateResult('endpointsResult', `<div>${results}</div>`);
        }

        async function testUpload() {
            log('üì§ Test upload photo...', 'info');
            
            const token = localStorage.getItem('access_token') || authToken;
            const fileInput = document.getElementById('testImage');
            const enseignantId = document.getElementById('enseignantId').value;
            
            // V√©rifications pr√©alables
            if (!token) {
                log('‚ùå Pas de token pour l\'upload', 'error');
                updateResult('uploadResult', '<div class="error">‚ùå Token requis</div>', 'error');
                return;
            }

            if (!fileInput.files[0]) {
                log('‚ùå Aucun fichier s√©lectionn√©', 'error');
                updateResult('uploadResult', '<div class="error">‚ùå S√©lectionnez un fichier</div>', 'error');
                return;
            }

            if (!enseignantId) {
                log('‚ùå ID enseignant requis', 'error');
                updateResult('uploadResult', '<div class="error">‚ùå ID enseignant requis</div>', 'error');
                return;
            }

            const file = fileInput.files[0];
            log(`üìÅ Fichier: ${file.name} (${file.type}, ${(file.size/1024).toFixed(1)}KB)`, 'info');
            log(`üë§ Enseignant ID: ${enseignantId}`, 'info');
            log(`üîë Token: ${token.substring(0, 30)}...`, 'info');

            try {
                // V√©rifications du fichier
                if (!file.type.startsWith('image/')) {
                    throw new Error('Le fichier doit √™tre une image');
                }
                if (file.size > 5 * 1024 * 1024) {
                    throw new Error('Fichier trop volumineux (max 5MB)');
                }

                log('‚úÖ Validations fichier OK', 'success');

                // Pr√©parer FormData
                const formData = new FormData();
                formData.append('file', file);

                log('üì§ Envoi de la requ√™te upload...', 'info');

                const uploadUrl = `${API_BASE}/users/enseignants/${enseignantId}/upload-photo`;
                log(`üåê URL: ${uploadUrl}`, 'info');

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                log(`üì° Statut r√©ponse: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìã Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`, 'info');

                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Upload r√©ussi!', 'success');
                    log(`üì∏ Photo URL: ${result.photo_url}`, 'success');
                    
                    updateResult('uploadResult', `
                        <div class="success">‚úÖ Upload r√©ussi!</div>
                        <p>Photo URL: ${result.photo_url}</p>
                        <p>Message: ${result.message}</p>
                    `, 'success');
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText };
                    }
                    
                    log(`‚ùå √âchec upload: ${errorData.detail || errorText}`, 'error');
                    
                    updateResult('uploadResult', `
                        <div class="error">‚ùå √âchec upload (${response.status})</div>
                        <p>Erreur: ${errorData.detail || errorText}</p>
                    `, 'error');
                }

            } catch (error) {
                log(`‚ùå Erreur upload: ${error.message}`, 'error');
                updateResult('uploadResult', `<div class="error">‚ùå Erreur: ${error.message}</div>`, 'error');
            }
        }

        // Auto-check environment on load
        window.onload = function() {
            log('üöÄ Page charg√©e - Diagnostic pr√™t', 'info');
            checkEnvironment();
        };
    </script>
</body>
</html>
