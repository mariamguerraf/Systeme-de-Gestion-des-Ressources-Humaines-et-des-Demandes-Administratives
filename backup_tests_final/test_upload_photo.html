<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Upload Photo Enseignant</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            border: 1px solid #ddd; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            background: #f9f9f9; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        input {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        img {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Upload Photo Enseignant</h1>
    
    <div class="test-section">
        <h2>1. Connexion Admin</h2>
        <button onclick="loginAsAdmin()">Se connecter en tant qu'Admin</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Upload Photo pour un Enseignant</h2>
        <div>
            <label>ID Enseignant:</label>
            <input type="number" id="enseignantId" value="6" placeholder="ID de l'enseignant">
        </div>
        <div>
            <label>Choisir Photo:</label>
            <input type="file" id="photoFile" accept="image/*">
        </div>
        <button onclick="uploadPhoto()">Upload Photo</button>
        <div id="uploadResult"></div>
        <div id="photoPreview"></div>
    </div>

    <div class="test-section">
        <h2>3. V√©rifier Photo Upload√©e</h2>
        <button onclick="checkEnseignantPhoto()">V√©rifier Photo</button>
        <div id="checkResult"></div>
    </div>

    <div class="test-section">
        <h2>üìã Log des requ√™tes</h2>
        <button onclick="clearLog()">Effacer Log</button>
        <div id="requestLog" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let authToken = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('requestLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('requestLog').innerHTML = '';
        }

        async function loginAsAdmin() {
            try {
                log('üîê Connexion admin en cours...', 'info');
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@univ.ma',
                        password: 'admin123'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.access_token;
                    log('‚úÖ Connexion admin r√©ussie!', 'success');
                    document.getElementById('loginResult').innerHTML = 
                        `<div class="success">‚úÖ Admin connect√©! Token: ${authToken.substring(0, 20)}...</div>`;
                } else {
                    log(`‚ùå Erreur connexion: ${result.detail}`, 'error');
                    document.getElementById('loginResult').innerHTML = 
                        `<div class="error">‚ùå Erreur: ${result.detail}</div>`;
                }
            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
                document.getElementById('loginResult').innerHTML = 
                    `<div class="error">‚ùå Erreur de connexion: ${error.message}</div>`;
            }
        }

        async function uploadPhoto() {
            if (!authToken) {
                alert('Veuillez vous connecter d\'abord');
                return;
            }

            const enseignantId = document.getElementById('enseignantId').value;
            const fileInput = document.getElementById('photoFile');
            const file = fileInput.files[0];

            if (!enseignantId) {
                alert('Veuillez saisir l\'ID de l\'enseignant');
                return;
            }

            if (!file) {
                alert('Veuillez choisir une photo');
                return;
            }

            try {
                log(`üì§ Upload photo pour enseignant ID ${enseignantId}...`, 'info');
                log(`üìÅ Fichier: ${file.name} (${file.type}, ${(file.size/1024).toFixed(1)}KB)`, 'info');
                
                // V√©rifications c√¥t√© client
                if (!file.type.startsWith('image/')) {
                    throw new Error('Le fichier doit √™tre une image');
                }

                if (file.size > 5 * 1024 * 1024) {
                    throw new Error('Le fichier ne doit pas d√©passer 5MB');
                }

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/users/enseignants/${enseignantId}/upload-photo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                log(`üì° Statut r√©ponse: ${response.status}`, 'info');
                log(`üì° Headers r√©ponse: ${JSON.stringify(Object.fromEntries(response.headers))}`, 'info');

                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Photo upload√©e avec succ√®s!', 'success');
                    document.getElementById('uploadResult').innerHTML = 
                        `<div class="success">‚úÖ Photo upload√©e avec succ√®s!</div>
                         <pre>${JSON.stringify(result, null, 2)}</pre>`;
                    
                    // Afficher un aper√ßu
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('photoPreview').innerHTML = 
                            `<h4>Aper√ßu de la photo upload√©e:</h4>
                             <img src="${e.target.result}" alt="Photo upload√©e">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    log(`‚ùå Erreur upload: ${result.detail}`, 'error');
                    document.getElementById('uploadResult').innerHTML = 
                        `<div class="error">‚ùå Erreur: ${result.detail}</div>
                         <pre>R√©ponse: ${JSON.stringify(result, null, 2)}</pre>`;
                }
            } catch (error) {
                log(`‚ùå Erreur upload: ${error.message}`, 'error');
                document.getElementById('uploadResult').innerHTML = 
                    `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function checkEnseignantPhoto() {
            if (!authToken) {
                alert('Veuillez vous connecter d\'abord');
                return;
            }

            const enseignantId = document.getElementById('enseignantId').value;

            if (!enseignantId) {
                alert('Veuillez saisir l\'ID de l\'enseignant');
                return;
            }

            try {
                log(`üîç V√©rification photo enseignant ID ${enseignantId}...`, 'info');
                
                const response = await fetch(`${API_BASE}/users/enseignants/${enseignantId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    if (result.photo) {
                        log('‚úÖ Enseignant a une photo!', 'success');
                        document.getElementById('checkResult').innerHTML = 
                            `<div class="success">‚úÖ Photo trouv√©e: ${result.photo}</div>
                             <img src="${API_BASE}${result.photo}" alt="Photo enseignant" onerror="this.style.display='none'">
                             <pre>${JSON.stringify(result, null, 2)}</pre>`;
                    } else {
                        log('‚ö†Ô∏è Enseignant sans photo', 'info');
                        document.getElementById('checkResult').innerHTML = 
                            `<div class="info">‚ö†Ô∏è Cet enseignant n'a pas de photo</div>
                             <pre>${JSON.stringify(result, null, 2)}</pre>`;
                    }
                } else {
                    log(`‚ùå Erreur v√©rification: ${result.detail}`, 'error');
                    document.getElementById('checkResult').innerHTML = 
                        `<div class="error">‚ùå Erreur: ${result.detail}</div>`;
                }
            } catch (error) {
                log(`‚ùå Erreur v√©rification: ${error.message}`, 'error');
                document.getElementById('checkResult').innerHTML = 
                    `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Auto-connexion au chargement de la page
        window.onload = function() {
            log('üöÄ Page charg√©e - Pr√™t pour les tests', 'info');
        };
    </script>
</body>
</html>
